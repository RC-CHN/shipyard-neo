# Shipyard-Neo ä»£ç å®¡æŸ¥æ¸…å•

> **å®¡æŸ¥è€…è§†è§’**: Linus Torvalds é£æ ¼çš„ä»£ç è´¨é‡å®¡æŸ¥
>
> **æ ¸å¿ƒåŸåˆ™**:
> - "å¥½å“å‘³"æ˜¯è®©ç‰¹æ®Šæƒ…å†µæ¶ˆå¤±ã€æ•°æ®ç»“æ„æ­£ç¡®ã€ä»£ç ç®€æ´æ¸…æ™°
> - **è½»é‡åŒ–ä¼˜å…ˆ**ï¼šæ‹’ç»å¼•å…¥ä¸å¿…è¦çš„é‡å‹ä¾èµ–ï¼Œç”¨æœ€ç®€å•çš„æ–¹æ¡ˆè§£å†³å®é™…é—®é¢˜
> - "Theory loses. Every single time." â€” è§£å†³çœŸå®é—®é¢˜ï¼Œä¸åšè¿‡åº¦è®¾è®¡
>
> **æœ€åæ›´æ–°**: 2026-02-02

---

## æ€»ä½“è¯„ä»·

è¿™ä¸ªé¡¹ç›®æ¶æ„æ¸…æ™°ï¼Œåˆ†å±‚åˆç†ï¼ˆBay ç¼–æ’å±‚ + Ship è¿è¡Œæ—¶ï¼‰ã€‚æ•°æ®æ¨¡å‹è®¾è®¡ä½“ç°äº†"è®¡ç®—ä¸å­˜å‚¨åˆ†ç¦»"çš„æ ¸å¿ƒç†å¿µã€‚é¡¹ç›®å·²ç»å¾ˆå¥½åœ°ä¿æŒäº†è½»é‡åŒ–â€”â€”ä»…ä¾èµ– FastAPI + SQLite/SQLModel + Dockerï¼Œæ²¡æœ‰å¼•å…¥ Redis/etcd ç­‰åˆ†å¸ƒå¼ç»„ä»¶ã€‚

ä»¥ä¸‹å®¡æŸ¥å»ºè®®å‡éµå¾ª**è½»é‡åŒ–åŸåˆ™**ï¼Œä¼˜å…ˆä½¿ç”¨ç°æœ‰å·¥å…·å’Œç®€å•æ–¹æ¡ˆã€‚

---

## ğŸ”´ é«˜ä¼˜å…ˆçº§å®¡æŸ¥é¡¹

### 1. âœ… å¹¶å‘æ§åˆ¶ä¸é”æœºåˆ¶ï¼ˆå·²æ”¹è¿›ï¼‰

**æ–‡ä»¶**: [`pkgs/bay/app/concurrency/locks.py`](pkgs/bay/app/concurrency/locks.py)

**å½“å‰çŠ¶æ€**: å·²é‡æ„ä¸ºç‹¬ç«‹æ¨¡å—ï¼Œæä¾›æ›´å¥½çš„é”ç®¡ç†ã€‚

```python
# æ–°å®ç° - ç‹¬ç«‹çš„é”æ¨¡å—
async def get_sandbox_lock(sandbox_id: str) -> asyncio.Lock
async def cleanup_sandbox_lock(sandbox_id: str) -> None
async def cleanup_deleted_sandbox_locks(active_sandbox_ids: set[str]) -> None
```

**å·²è§£å†³**:
- [x] é”é€»è¾‘ä» SandboxManager æŠ½ç¦»åˆ°ç‹¬ç«‹æ¨¡å—
- [x] æä¾› `cleanup_deleted_sandbox_locks()` æ¸…ç†å·²åˆ é™¤ sandbox çš„é”
- [x] SQLite stale read é—®é¢˜å·²ä¿®å¤ï¼ˆ`fix(bay): resolve SQLite stale read issues`ï¼‰

**å¾…æ”¹è¿›**:
- [ ] å¤šå®ä¾‹éƒ¨ç½²ä»éœ€ä¾èµ–æ•°æ®åº“ä¹è§‚é”
- [ ] é”è¶…æ—¶æœºåˆ¶ï¼ˆé¿å…æ­»é”ï¼‰

---

### 2. âœ… è·¯å¾„å®‰å…¨æ ¡éªŒï¼ˆå·²å®ç°ï¼‰

**æ–‡ä»¶**: [`pkgs/bay/app/validators/path.py`](pkgs/bay/app/validators/path.py)

**å½“å‰çŠ¶æ€**: Bay ä¾§å·²å®ç°å®Œæ•´çš„è·¯å¾„æ ¡éªŒï¼Œä¸ Ship å½¢æˆåŒå±‚é˜²æŠ¤ã€‚

```python
def validate_relative_path(path: str) -> str:
    """æ ¡éªŒç›¸å¯¹è·¯å¾„ï¼Œæ‹’ç»ç»å¯¹è·¯å¾„å’Œç›®å½•ç©¿è¶Š"""

def validate_optional_relative_path(path: str | None) -> str | None:
    """å¯é€‰è·¯å¾„æ ¡éªŒ"""
```

**å·²è§£å†³**:
- [x] Bay ä¾§è·¯å¾„æ ¡éªŒå®ç°ï¼ˆç¦æ­¢ç»å¯¹è·¯å¾„ã€ç›®å½•ç©¿è¶Šï¼‰
- [x] ä¸ Ship `resolve_path` å¯¹é½
- [x] å•å…ƒæµ‹è¯•è¦†ç›– (`test_path_validator.py`)
- [x] E2E æµ‹è¯•è¦†ç›– (`test_path_security.py`)

---

### 3. å¼‚å¸¸å¤„ç†ä¸èµ„æºæ³„éœ²

**æ–‡ä»¶**: [`pkgs/bay/app/managers/session/session.py`](pkgs/bay/app/managers/session/session.py:128)

**é—®é¢˜**: å®¹å™¨åˆ›å»ºåå¯åŠ¨å¤±è´¥ï¼Œå®¹å™¨æœªæ¸…ç†ï¼š

```python
# create container
container_id = await self._driver.create(...)
session.container_id = container_id
await self._db.commit()

# start container - å¦‚æœè¿™é‡Œå¤±è´¥
try:
    endpoint = await self._driver.start(...)
except Exception as e:
    session.observed_state = SessionStatus.FAILED
    await self._db.commit()
    raise  # å®¹å™¨å·²åˆ›å»ºä½†æœªæ¸…ç†ï¼
```

**å®¡æŸ¥è¦ç‚¹**:
- [ ] å®¹å™¨åˆ›å»ºæˆåŠŸä½†å¯åŠ¨å¤±è´¥æ—¶ï¼Œå®¹å™¨ä¼šå˜æˆå­¤å„¿
- [ ] éœ€è¦åœ¨ `ensure_running` å¤±è´¥è·¯å¾„ä¸­æ¸…ç†å®¹å™¨
- [ ] è€ƒè™‘ä½¿ç”¨ `try/finally` æˆ–äº‹åŠ¡æ€§åˆ›å»ºæ¨¡å¼

---

### 4. æ—¶é—´ç›¸å…³çš„ç«æ€æ¡ä»¶

**æ–‡ä»¶**: [`pkgs/bay/app/models/sandbox.py`](pkgs/bay/app/models/sandbox.py:77)

**é—®é¢˜**: `is_expired` å±æ€§æ¯æ¬¡è°ƒç”¨éƒ½é‡æ–°è®¡ç®— `datetime.utcnow()`ï¼š

```python
@property
def is_expired(self) -> bool:
    if self.expires_at is None:
        return False
    return datetime.utcnow() > self.expires_at  # æ¯æ¬¡è°ƒç”¨æ—¶é—´ä¸åŒ
```

**å®¡æŸ¥è¦ç‚¹**:
- [ ] åŒä¸€ä¸ªè¯·æ±‚å¤„ç†æµç¨‹ä¸­å¤šæ¬¡æ£€æŸ¥ `is_expired` å¯èƒ½å¾—åˆ°ä¸åŒç»“æœ
- [ ] [`compute_status()`](pkgs/bay/app/models/sandbox.py:83) è°ƒç”¨ `is_expired`ï¼Œå¯èƒ½å¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´
- [ ] è€ƒè™‘åœ¨è¯·æ±‚ä¸Šä¸‹æ–‡ä¸­å›ºå®šæ—¶é—´åŸºå‡†

---

### 5. httpx å®¢æˆ·ç«¯è¿æ¥ç®¡ç†

**æ–‡ä»¶**: [`pkgs/bay/app/adapters/ship.py`](pkgs/bay/app/adapters/ship.py:64)

**é—®é¢˜**: æ¯æ¬¡è¯·æ±‚éƒ½åˆ›å»ºæ–°çš„ `AsyncClient`ï¼š

```python
async def _request(...):
    async with httpx.AsyncClient() as client:  # æ¯æ¬¡è¯·æ±‚éƒ½æ–°å»º
        response = await client.request(...)
```

**å®¡æŸ¥è¦ç‚¹**:
- [ ] é¢‘ç¹åˆ›å»º/é”€æ¯è¿æ¥ï¼Œæ€§èƒ½å¼€é”€å¤§
- [ ] æ— æ³•å¤ç”¨ HTTP/2 è¿æ¥
- [ ] åº”è¯¥ä½¿ç”¨è¿æ¥æ± æˆ–å•ä¾‹å®¢æˆ·ç«¯
- [ ] [`_wait_for_ready()`](pkgs/bay/app/managers/session/session.py:206) åŒæ ·çš„é—®é¢˜

**è½»é‡åŒ–å»ºè®®**: åœ¨ `ShipAdapter` ç±»ä¸­æŒæœ‰ä¸€ä¸ª `httpx.AsyncClient` å®ä¾‹ï¼Œåœ¨ `__init__` æˆ–é¦–æ¬¡ä½¿ç”¨æ—¶åˆ›å»ºã€‚è¿™æ˜¯é›¶æˆæœ¬ä¼˜åŒ–ï¼Œä¸å¼•å…¥ä»»ä½•æ–°ä¾èµ–ã€‚

---

## ğŸŸ  ä¸­ä¼˜å…ˆçº§å®¡æŸ¥é¡¹

### 6. Shell å‘½ä»¤æ³¨å…¥é£é™©

**æ–‡ä»¶**: [`pkgs/ship/app/components/user_manager.py`](pkgs/ship/app/components/user_manager.py:240)

**ä»£ç **:
```python
sudo_args.extend([
    "bash",
    "-lc",
    f"cd {shlex.quote(str(working_dir))} && {command}",  # command æœªè½¬ä¹‰
])
```

**å®¡æŸ¥è¦ç‚¹**:
- [ ] `command` ç›´æ¥æ‹¼æ¥åˆ° shell å‘½ä»¤ä¸­ï¼Œè™½ç„¶å‰é¢æœ‰ `shlex.quote(working_dir)`
- [ ] ç”¨æˆ·ä¼ å…¥çš„ `command` å¯ä»¥åŒ…å«ä»»æ„ shell å‘½ä»¤ï¼ˆè¿™å¯èƒ½æ˜¯è®¾è®¡æ„å›¾ï¼Œä½†éœ€è¦ç¡®è®¤ï¼‰
- [ ] æ˜¯å¦éœ€è¦å¯¹å±é™©å‘½ä»¤åšé»‘åå•ï¼Ÿ
- [ ] cwd å‚æ•°å·²åšæ ¡éªŒï¼Œä½† env å‚æ•°å‘¢ï¼Ÿ

---

### 7. åå°è¿›ç¨‹å†…å­˜æ³„éœ²

**æ–‡ä»¶**: [`pkgs/ship/app/components/user_manager.py`](pkgs/ship/app/components/user_manager.py:24)

**é—®é¢˜**: åå°è¿›ç¨‹æ³¨å†Œè¡¨æ°¸è¿œå¢é•¿ï¼š

```python
_background_processes: Dict[str, "BackgroundProcessEntry"] = {}
```

**å®¡æŸ¥è¦ç‚¹**:
- [ ] è¿›ç¨‹å®Œæˆåï¼Œ`_background_processes` ä¸­çš„æ¡ç›®ä»ä¸åˆ é™¤
- [ ] é•¿æ—¶é—´è¿è¡Œçš„ Ship å®¹å™¨ä¼šç´¯ç§¯å¤§é‡åƒµå°¸æ¡ç›®
- [ ] `Process` å¯¹è±¡æŒæœ‰èµ„æºï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æ³„éœ²
- [ ] éœ€è¦æ·»åŠ æ¸…ç†æœºåˆ¶ï¼ˆå®šæ—¶æ¸…ç†å·²å®Œæˆè¿›ç¨‹ï¼‰

**è½»é‡åŒ–å»ºè®®**: 
- åœ¨ `get_background_processes()` è°ƒç”¨æ—¶é¡ºä¾¿æ¸…ç† `returncode is not None` çš„æ¡ç›®
- æˆ–è®¾ç½®æœ€å¤§æ¡ç›®æ•°é™åˆ¶ï¼ŒFIFO æ·˜æ±°è€æ¡ç›®
- æ— éœ€å¼•å…¥åå°å®šæ—¶ä»»åŠ¡æ¡†æ¶

---

### 8. é…ç½®çƒ­åŠ è½½ä¸ç¼“å­˜

**æ–‡ä»¶**: [`pkgs/bay/app/config.py`](pkgs/bay/app/config.py:221)

**é—®é¢˜**: `@lru_cache` å¯¼è‡´é…ç½®æ— æ³•åŠ¨æ€æ›´æ–°ï¼š

```python
@lru_cache
def get_settings() -> Settings:
    ...
```

**å®¡æŸ¥è¦ç‚¹**:
- [ ] é…ç½®è¢«æ°¸ä¹…ç¼“å­˜ï¼Œæ— æ³•çƒ­åŠ è½½
- [ ] æµ‹è¯•ä¸­éœ€è¦æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜ï¼š`get_settings.cache_clear()`
- [ ] æ˜¯å¦éœ€è¦æ”¯æŒé…ç½®çƒ­æ›´æ–°ï¼Ÿ
- [ ] è€ƒè™‘ä½¿ç”¨ä¾èµ–æ³¨å…¥è€Œéå…¨å±€å•ä¾‹

---

### 9. æ•°æ®åº“äº‹åŠ¡è¾¹ç•Œ

**æ–‡ä»¶**: [`pkgs/bay/app/managers/sandbox/sandbox.py`](pkgs/bay/app/managers/sandbox/sandbox.py:381)

**é—®é¢˜**: `delete()` æ–¹æ³•ä¸­å¤šæ¬¡ commitï¼Œäº‹åŠ¡è¾¹ç•Œä¸æ¸…æ™°ï¼š

```python
async def delete(self, sandbox: Sandbox) -> None:
    # ... é”€æ¯ sessions
    for session in sessions:
        await self._session_mgr.destroy(session)  # å¯èƒ½æœ‰è‡ªå·±çš„ commit

    # è½¯åˆ é™¤ sandbox
    sandbox.deleted_at = datetime.utcnow()
    await self._db.commit()  # commit 1

    # çº§è”åˆ é™¤ workspace
    if workspace and workspace.managed:
        await self._workspace_mgr.delete(...)  # commit 2
```

**å®¡æŸ¥è¦ç‚¹**:
- [ ] å¦‚æœä¸­é€”å¤±è´¥ï¼Œä¼šç•™ä¸‹éƒ¨åˆ†åˆ é™¤çš„çŠ¶æ€
- [ ] åº”è¯¥ä½¿ç”¨å•ä¸€äº‹åŠ¡åŒ…è£¹æ•´ä¸ªåˆ é™¤æ“ä½œ
- [ ] æˆ–è€…æ”¹ç”¨æœ€ç»ˆä¸€è‡´æ€§ + é‡è¯•æœºåˆ¶

---

### 10. Profile æŸ¥æ‰¾æ•ˆç‡

**æ–‡ä»¶**: [`pkgs/bay/app/config.py`](pkgs/bay/app/config.py:186)

**é—®é¢˜**: çº¿æ€§æŸ¥æ‰¾ Profileï¼š

```python
def get_profile(self, profile_id: str) -> ProfileConfig | None:
    for profile in self.profiles:
        if profile.id == profile_id:
            return profile
    return None
```

**å®¡æŸ¥è¦ç‚¹**:
- [ ] æ¯æ¬¡è¯·æ±‚éƒ½éå†æ•´ä¸ª profiles åˆ—è¡¨
- [ ] Profile æ•°é‡å¢å¤šåæ€§èƒ½ä¸‹é™
- [ ] åº”è¯¥åœ¨åˆå§‹åŒ–æ—¶æ„å»º `dict[str, ProfileConfig]`

---

## ğŸŸ¡ ä½ä¼˜å…ˆçº§å®¡æŸ¥é¡¹

### 11. é”™è¯¯ç±»å‹å‘½åå†²çª

**æ–‡ä»¶**: [`pkgs/bay/app/errors.py`](pkgs/bay/app/errors.py:142)

**é—®é¢˜**: è‡ªå®šä¹‰ `FileNotFoundError` ä¸ Python å†…ç½®ç±»å‹åŒåï¼š

```python
class FileNotFoundError(BayError):  # è¦†ç›–äº† builtins.FileNotFoundError
    ...
```

**å®¡æŸ¥è¦ç‚¹**:
- [ ] å¯èƒ½å¯¼è‡´ `except FileNotFoundError` æ•è·é”™è¯¯çš„å¼‚å¸¸
- [ ] å»ºè®®é‡å‘½åä¸º `WorkspaceFileNotFoundError` æˆ–ç±»ä¼¼

---

### 12. æ—¥å¿—ä¿¡æ¯å®Œæ•´æ€§

**æ–‡ä»¶**: [`pkgs/bay/app/drivers/docker/docker.py`](pkgs/bay/app/drivers/docker/docker.py:149)

**é—®é¢˜**: TODO æ³¨é‡Šè¡¨æ˜ owner ä¿¡æ¯ç¼ºå¤±ï¼š

```python
container_labels = {
    "bay.owner": "default",  # TODO: get from session/sandbox
    ...
}
```

**å®¡æŸ¥è¦ç‚¹**:
- [ ] å®¹å™¨æ ‡ç­¾ä¸­çš„ owner è¢«ç¡¬ç¼–ç ä¸º "default"
- [ ] å½±å“å¤šç§Ÿæˆ·éš”ç¦»å’Œèµ„æºè¿½è¸ª
- [ ] éœ€è¦ä» session/sandbox ä¼ é€’çœŸå® owner

---

### 13. ç¡¬ç¼–ç çš„ç«¯å£å’Œè¶…æ—¶

**æ–‡ä»¶**: å¤šå¤„

**å®¡æŸ¥è¦ç‚¹**:
- [ ] [`pkgs/bay/app/config.py:105`](pkgs/bay/app/config.py:105): `runtime_port: int | None = 8123`
- [ ] [`pkgs/bay/app/managers/session/session.py:176`](pkgs/bay/app/managers/session/session.py:176): `max_wait_seconds: float = 120.0`
- [ ] [`pkgs/bay/app/adapters/ship.py:43`](pkgs/bay/app/adapters/ship.py:43): `timeout: float = 30.0`
- [ ] è¿™äº›é­”æ³•æ•°å­—åº”è¯¥é›†ä¸­åˆ°é…ç½®æ–‡ä»¶

---

### 14. ç±»å‹æ³¨è§£ä¸ä¸€è‡´

**æ–‡ä»¶**: [`pkgs/bay/app/api/v1/sandboxes.py`](pkgs/bay/app/api/v1/sandboxes.py:58)

**é—®é¢˜**: å‡½æ•°å‚æ•°ç±»å‹æ³¨è§£ä½¿ç”¨äº†æ—§é£æ ¼ï¼š

```python
def _sandbox_to_response(sandbox, current_session=None) -> SandboxResponse:
    # sandbox å’Œ current_session æ²¡æœ‰ç±»å‹æ³¨è§£
```

**å®¡æŸ¥è¦ç‚¹**:
- [ ] éƒ¨åˆ†å‡½æ•°ç¼ºå°‘å®Œæ•´çš„ç±»å‹æ³¨è§£
- [ ] æ··ç”¨ `str | None` å’Œ `Optional[str]`ï¼Œåº”ç»Ÿä¸€é£æ ¼

---

### 15. æµ‹è¯•è¦†ç›–åº¦

**æ–‡ä»¶**: `pkgs/bay/tests/`, `pkgs/ship/tests/`

**å®¡æŸ¥è¦ç‚¹**:
- [ ] å•å…ƒæµ‹è¯•æ˜¯å¦è¦†ç›–äº†å¹¶å‘åœºæ™¯ï¼Ÿ
- [ ] æ˜¯å¦æœ‰é’ˆå¯¹èµ„æºæ³„éœ²çš„æµ‹è¯•ï¼Ÿ
- [ ] æ˜¯å¦æœ‰è¾¹ç•Œæ¡ä»¶æµ‹è¯•ï¼ˆå¦‚ TTL=0, ç©ºå‘½ä»¤ç­‰ï¼‰ï¼Ÿ
- [ ] é›†æˆæµ‹è¯•æ˜¯å¦æ¨¡æ‹Ÿäº†ç½‘ç»œåˆ†åŒºã€å®¹å™¨å´©æºƒç­‰å¼‚å¸¸åœºæ™¯ï¼Ÿ

---

## ğŸ“‹ æ¶æ„å±‚é¢å®¡æŸ¥

### 16. âœ… GC æœºåˆ¶ï¼ˆå·²å®ç°ï¼‰

**çŠ¶æ€**: å·²å®Œæ•´å®ç°åå° GC è°ƒåº¦å™¨å’Œå„ç±»å›æ”¶ä»»åŠ¡

**æ–‡ä»¶**: [`pkgs/bay/app/services/gc/`](pkgs/bay/app/services/gc/)

```
pkgs/bay/app/services/gc/
â”œâ”€â”€ scheduler.py          # GCScheduler - åå°è°ƒåº¦å™¨
â”œâ”€â”€ coordinator.py        # GC åè°ƒå™¨
â”œâ”€â”€ lifecycle.py          # GC ç”Ÿå‘½å‘¨æœŸç®¡ç†
â”œâ”€â”€ base.py               # GCTask åŸºç±»
â””â”€â”€ tasks/
    â”œâ”€â”€ idle_session.py       # IdleSessionGC
    â”œâ”€â”€ expired_sandbox.py    # ExpiredSandboxGC
    â”œâ”€â”€ orphan_workspace.py   # OrphanWorkspaceGC
    â””â”€â”€ orphan_container.py   # OrphanContainerGC
```

**å·²è§£å†³**:
- [x] **IdleSessionGC**ï¼šç©ºé—² Session å›æ”¶ï¼ˆidle_expires_at è¿‡æœŸï¼‰
- [x] **ExpiredSandboxGC**ï¼šè¿‡æœŸ Sandbox æ¸…ç†ï¼ˆexpires_at è¿‡æœŸï¼‰
- [x] **OrphanWorkspaceGC**ï¼šå­¤å„¿ managed workspace æ¸…ç†
- [x] **OrphanContainerGC**ï¼šå­¤å„¿å®¹å™¨æ£€æµ‹ä¸æ¸…ç†
- [x] GC è°ƒåº¦å™¨æ¡†æ¶ï¼ˆGCTask + GCSchedulerï¼‰
- [x] é…ç½®åŒ– GC é—´éš”ä¸å¼€å…³
- [x] Admin API æ”¯æŒæ‰‹åŠ¨è§¦å‘ GCï¼ˆç”¨äºæµ‹è¯•ï¼‰
- [x] å•å…ƒæµ‹è¯• (`test_gc_scheduler.py`, `test_gc_tasks.py`)
- [x] E2E æµ‹è¯• (`test_gc_e2e.py`, `test_gc_workflow_scenario.py`)

**å¾…å®Œæˆ**:
- [ ] å¯åŠ¨æ—¶ reconcileï¼ˆå¯¹è´¦å­¤å„¿èµ„æºï¼‰

---

### 17. å¯è§‚æµ‹æ€§ç¼ºå¤±

**å®¡æŸ¥è¦ç‚¹**:
- [ ] æ—  Prometheus metrics åŸ‹ç‚¹
- [ ] æ— åˆ†å¸ƒå¼è¿½è¸ª (OpenTelemetry)
- [ ] æ—¥å¿—ç¼ºå°‘è¯·æ±‚ä¸Šä¸‹æ–‡ï¼ˆè™½ç„¶æœ‰ request_idï¼Œä½†æœªè´¯ç©¿ï¼‰
- [ ] æ— å¥åº·æ£€æŸ¥çš„è¯¦ç»†çŠ¶æ€ï¼ˆä»…è¿”å› `{"status": "healthy"}`ï¼‰

**è½»é‡åŒ–å»ºè®®**:
- Metrics: è€ƒè™‘ `prometheus-fastapi-instrumentator`ï¼ˆ<100è¡Œæ¥å…¥ï¼‰
- Tracing: æš‚ç¼“ï¼Œç­‰æœ‰çœŸå®æ’æŸ¥éœ€æ±‚å†åŠ 
- å¥åº·æ£€æŸ¥: å¢åŠ æ•°æ®åº“è¿æ¥æ£€æµ‹ã€Docker è¿æ¥æ£€æµ‹å³å¯

---

### 18. æ•°æ®è¿ç§»ç­–ç•¥

**å®¡æŸ¥è¦ç‚¹**:
- [ ] ä½¿ç”¨ SQLite ä½œä¸ºé»˜è®¤æ•°æ®åº“ï¼Œç”Ÿäº§ç¯å¢ƒè¿ç§»è·¯å¾„ä¸æ¸…æ™°
- [ ] æ—  Alembic è¿ç§»è„šæœ¬ï¼ˆæˆ–æœªæ‰¾åˆ°ï¼‰
- [ ] Model å˜æ›´åçš„å‘åå…¼å®¹æ€§

**è½»é‡åŒ–å»ºè®®**:
- ä¿æŒ SQLite ä½œä¸ºé»˜è®¤é€‰é¡¹ï¼Œå¯¹äºç»å¤§å¤šæ•°å•æœºéƒ¨ç½²åœºæ™¯è¶³å¤Ÿ
- ä»…å½“æ˜ç¡®éœ€è¦å¤šå®ä¾‹æ—¶å†è€ƒè™‘ PostgreSQL
- ç”¨ `alembic` ç®¡ç†è¿ç§»ï¼Œå®ƒæ˜¯æ ‡å‡†åšæ³•ä¸”è¶³å¤Ÿè½»é‡

---

## ğŸ”§ è¯­è¨€é€‰å‹è®¨è®ºï¼šPython vs Rust/Go

### ç°çŠ¶åˆ†æ

å½“å‰é¡¹ç›®å…¨æ ˆä½¿ç”¨ Python (FastAPI)ï¼Œè¿™æ˜¯ä¸€ä¸ª**åˆç†çš„åˆæœŸé€‰æ‹©**ï¼š
- å¼€å‘é€Ÿåº¦å¿«ï¼Œç”Ÿæ€ä¸°å¯Œ
- å›¢é˜Ÿç†Ÿæ‚‰åº¦é«˜ï¼ˆå‡è®¾ï¼‰
- åŸå‹éªŒè¯é˜¶æ®µè¶³å¤Ÿ

### è€ƒè™‘å¼•å…¥ Rust/Go çš„åœºæ™¯

| ç»„ä»¶ | å½“å‰è¯­è¨€ | æ˜¯å¦å€¼å¾—é‡å†™ | ç†ç”± |
|:---|:---|:---|:---|
| **Bay (ç¼–æ’å±‚)** | Python | âš ï¸ å¯è€ƒè™‘ Go | é«˜å¹¶å‘ API ç½‘å…³ï¼ŒGo çš„ goroutine æ¨¡å‹æ›´è½»é‡ |
| **Ship (è¿è¡Œæ—¶)** | Python | âŒ ä¸å»ºè®® | æ ¸å¿ƒæ˜¯ IPython å†…æ ¸ï¼Œå¿…é¡»ç”¨ Python |
| **Driver å±‚** | Python | ğŸŸ¡ è¿œæœŸè€ƒè™‘ | ä¸ Docker/K8s API äº¤äº’ï¼ŒGo æœ‰å¤©ç„¶ä¼˜åŠ¿ |
| **è·¯å¾„æ ¡éªŒ/å®‰å…¨** | Python | âœ… å¯è€ƒè™‘ Rust | æ€§èƒ½æ•æ„Ÿ + å®‰å…¨å…³é”®è·¯å¾„ |

### ğŸŸ¢ æ¨èç­–ç•¥ï¼šæ¸è¿›å¼æ··åˆæ¶æ„

**Phase 1ï¼šä¿æŒç°çŠ¶**
- å½“å‰ Python ä»£ç èƒ½æ­£å¸¸å·¥ä½œ
- é‡å†™çš„æˆæœ¬è¿œå¤§äºæ”¶ç›Š
- å…ˆæŠŠåŠŸèƒ½åšå®Œï¼Œå†è€ƒè™‘ä¼˜åŒ–

**Phase 2ï¼šè¯†åˆ«çƒ­ç‚¹è·¯å¾„** (å¦‚æœé‡åˆ°æ€§èƒ½ç“¶é¢ˆ)
- ç”¨ profiler æ‰¾å‡ºçœŸæ­£çš„ç“¶é¢ˆ
- é€šå¸¸æ˜¯ 10% çš„ä»£ç å  90% çš„æ—¶é—´

**Phase 3ï¼šå±€éƒ¨é‡å†™** (å¦‚æœæœ‰çœŸå®éœ€æ±‚)

å¯ä¼˜å…ˆè€ƒè™‘ç”¨ Rust/Go é‡å†™çš„éƒ¨åˆ†ï¼š

1. **Bay æ ¸å¿ƒ**ï¼ˆå¦‚æœé€‰æ‹©é‡å†™ï¼‰
   ```
   Go ä¼˜åŠ¿ï¼š
   - ç¼–è¯‘ä¸ºå•ä¸€äºŒè¿›åˆ¶ï¼Œéƒ¨ç½²ç®€å•
   - goroutine æ¯” asyncio æ›´è½»é‡
   - å†…å­˜å ç”¨è¿œä½äº Python
   - å¯åŠ¨æ—¶é—´ <100ms
   ```

2. **è·¯å¾„å®‰å…¨æ ¡éªŒ FFI æ¨¡å—**
   ```
   Rust ä¼˜åŠ¿ï¼š
   - å†…å­˜å®‰å…¨ï¼Œæ—  GC
   - å¯ç¼–è¯‘ä¸º Python æ‰©å±• (PyO3)
   - é€‚åˆå®‰å…¨å…³é”®é€»è¾‘
   ```

### âŒ ä¸å»ºè®®é‡å†™çš„éƒ¨åˆ†

1. **Ship è¿è¡Œæ—¶**
   - æ ¸å¿ƒæ˜¯ IPython å†…æ ¸ï¼ˆçº¯ Pythonï¼‰
   - ä¸ Python ç”Ÿæ€æ·±åº¦ç»‘å®š
   - ç”¨å…¶ä»–è¯­è¨€åè€Œå¢åŠ å¤æ‚åº¦

2. **SDK**
   - ç›®æ ‡ç”¨æˆ·æ˜¯ Python/AI å¼€å‘è€…
   - ä¿æŒ Python æ˜¯æ­£ç¡®é€‰æ‹©

### ğŸ’¡ Linus çš„è§‚ç‚¹

```
"æˆ‘æ˜¯ä¸ªè¯¥æ­»çš„å®ç”¨ä¸»ä¹‰è€…ã€‚"

ç”¨ä»€ä¹ˆè¯­è¨€ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯ï¼š
1. è¿™æ˜¯ä¸ªçœŸé—®é¢˜è¿˜æ˜¯è‡†æƒ³çš„ï¼Ÿâ€”â€” ä½ ç°åœ¨æœ‰æ€§èƒ½é—®é¢˜å—ï¼Ÿ
2. è§£å†³æ–¹æ¡ˆçš„å¤æ‚åº¦æ˜¯å¦ä¸é—®é¢˜åŒ¹é…ï¼Ÿâ€”â€” é‡å†™çš„æˆæœ¬ vs æ”¶ç›Š
3. å›¢é˜Ÿèƒ½å¦ç»´æŠ¤ï¼Ÿâ€”â€” å¼•å…¥æ–°è¯­è¨€æ„å‘³ç€æ–°çš„å­¦ä¹ æ›²çº¿

å¦‚æœ Python æ€§èƒ½çœŸçš„æˆä¸ºç“¶é¢ˆï¼ˆè€Œä¸æ˜¯"ç†è®ºä¸Šå¯èƒ½"ï¼‰ï¼Œ
å†è€ƒè™‘ç”¨ Go é‡å†™ Bay ç¼–æ’å±‚ã€‚
ä½† Ship å¿…é¡»ä¿æŒ Pythonâ€”â€”è¿™æ˜¯å®ƒçš„æ ¸å¿ƒä»·å€¼ã€‚
```

### ç»“è®º

| å†³ç­–ç‚¹ | å»ºè®® |
|:---|:---|
| ç°é˜¶æ®µ | ä¿æŒå…¨ Pythonï¼Œä¸“æ³¨åŠŸèƒ½å®Œæˆ |
| é‡åˆ° CPU ç“¶é¢ˆ | ç”¨ Go é‡å†™ Bay |
| é‡åˆ°å†…å­˜ç“¶é¢ˆ | ä¼˜åŒ–ç°æœ‰ Python ä»£ç  + è€ƒè™‘ Rust FFI |
| Ship è¿è¡Œæ—¶ | æ°¸è¿œä¿æŒ Python |

---

## âœ… å·²åšå¾—è¾ƒå¥½çš„éƒ¨åˆ†

1. **æ•°æ®æ¨¡å‹è®¾è®¡**: Sandbox/Session/Workspace åˆ†ç¦»æ¸…æ™°ï¼Œ`desired_state` vs `observed_state` æ˜¯æ­£ç¡®çš„æ¨¡å¼
2. **å¹‚ç­‰æ€§æ”¯æŒ**: Idempotency-Key æœºåˆ¶å®Œæ•´
3. **è·¯å¾„éš”ç¦»**: Ship ä¾§çš„ `resolve_path()` å®ç°æ­£ç¡®ï¼Œ**Bay ä¾§ä¹Ÿå·²å®ç°åŒå±‚é˜²æŠ¤**
4. **Profile æŠ½è±¡**: è¿è¡Œæ—¶è§„æ ¼æšä¸¾åŒ–ï¼Œé¿å…æ— é™è‡ªå®šä¹‰
5. **Adapter æ¨¡å¼**: ShipAdapter ä¸ºæœªæ¥å¤šè¿è¡Œæ—¶æ‰©å±•ç•™å‡ºäº†æ¥å£
6. **è½»é‡åŒ–æ¶æ„**: ä»…ä¾èµ– FastAPI + SQLite + Dockerï¼Œæ—  Redis/etcd/æ¶ˆæ¯é˜Ÿåˆ—ï¼Œéƒ¨ç½²ç®€å•
7. **GC æœºåˆ¶**: å®Œæ•´å®ç°åå°è°ƒåº¦å™¨ + å››ç§ GC ä»»åŠ¡ï¼ˆIdle Session / Expired Sandbox / Orphan Workspace / Orphan Containerï¼‰
8. **Extend TTL**: æ”¯æŒå»¶é•¿ Sandbox TTLï¼Œå¸¦å¹‚ç­‰æ€§ä¿æŠ¤
9. **å¹¶å‘é”æ¨¡å—**: ç‹¬ç«‹çš„é”ç®¡ç†æ¨¡å—ï¼Œæ”¯æŒé”æ¸…ç†
10. **æµ‹è¯•è¦†ç›–**: å¹¶è¡Œæµ‹è¯•æ”¯æŒï¼ˆpytest-xdistï¼‰ï¼ŒE2E åœºæ™¯ä¸°å¯Œ

---

## ğŸ’¡ è½»é‡åŒ–åŸåˆ™æé†’

åœ¨è§£å†³ä¸Šè¿°é—®é¢˜æ—¶ï¼ŒåŠ¡å¿…éµå¾ªï¼š

1. **"è§£å†³å®é™…é—®é¢˜ï¼Œä¸è§£å†³æƒ³è±¡çš„é—®é¢˜"**
   - å•å®ä¾‹éƒ¨ç½²å  90% åœºæ™¯ï¼Œä¼˜å…ˆä¿è¯å®ƒèƒ½ç”¨
   - å¤šå®ä¾‹æ”¯æŒå¯ä»¥é€šè¿‡æ•°æ®åº“ä¹è§‚é”è§£å†³ï¼Œæ— éœ€ Redis

2. **"æœ€ç®€å•çš„ä»£ç æ˜¯æœ€å¥½çš„ä»£ç "**
   - æ¸…ç†æœºåˆ¶ç”¨ç®€å•çš„æ¡ä»¶åˆ¤æ–­ï¼Œä¸å¼•å…¥åå°ä»»åŠ¡æ¡†æ¶
   - è¿æ¥æ± å¤ç”¨æ˜¯é›¶æˆæœ¬ä¼˜åŒ–ï¼Œåº”è¯¥ç«‹åˆ»åš

3. **"ä¸è¦è¿‡åº¦æŠ½è±¡"**
   - ç°æœ‰çš„ Driver/Adapter æŠ½è±¡å·²ç»è¶³å¤Ÿ
   - ä¸éœ€è¦ä¸º"æœªæ¥å¯èƒ½"çš„åœºæ™¯æ·»åŠ æ›´å¤šå±‚

---

## å®¡æŸ¥ä¼˜å…ˆçº§æ€»ç»“

| ä¼˜å…ˆçº§ | é¡¹ç›®æ•° | å…³é”®é—®é¢˜ |
|:---:|:---:|:---|
| ğŸ”´ é«˜ | 3 | ~~å¹¶å‘é”~~ âœ…ã€~~è·¯å¾„å®‰å…¨~~ âœ…ã€èµ„æºæ³„éœ²ã€æ—¶é—´ç«æ€ã€è¿æ¥ç®¡ç† |
| ğŸŸ  ä¸­ | 5 | å‘½ä»¤æ³¨å…¥ã€å†…å­˜æ³„éœ²ã€é…ç½®ç¼“å­˜ã€äº‹åŠ¡è¾¹ç•Œã€æŸ¥æ‰¾æ•ˆç‡ |
| ğŸŸ¡ ä½ | 5 | å‘½åå†²çªã€æ—¥å¿—å®Œæ•´æ€§ã€ç¡¬ç¼–ç ã€ç±»å‹æ³¨è§£ã€æµ‹è¯•è¦†ç›– |
| ğŸ“‹ æ¶æ„ | 2 | ~~GCæœºåˆ¶~~ âœ…ã€å¯è§‚æµ‹æ€§ã€æ•°æ®è¿ç§» |

### è¿›åº¦ç»Ÿè®¡

- **å·²è§£å†³**: 3 é¡¹ï¼ˆå¹¶å‘é”æ”¹è¿›ã€è·¯å¾„å®‰å…¨ã€GC æœºåˆ¶ï¼‰
- **å¾…è§£å†³**: 12 é¡¹
- **è¿›è¡Œä¸­**: 0 é¡¹

---

> **ä¸‹ä¸€æ­¥**: æŒ‰ä¼˜å…ˆçº§é€é¡¹è§£å†³ï¼Œæ¯é¡¹å®Œæˆååœ¨æ­¤æ–‡æ¡£æ ‡è®° âœ…
>
> **æ³¨æ„**: æ‰€æœ‰ä¿®å¤æ–¹æ¡ˆåº”ä¼˜å…ˆé€‰æ‹©ä¸å¼•å…¥æ–°ä¾èµ–çš„å®ç°æ–¹å¼

---

## ğŸ“ å˜æ›´å†å²

| æ—¥æœŸ | å˜æ›´å†…å®¹ |
|:---|:---|
| 2026-02-02 | æ›´æ–° GC æœºåˆ¶ä¸ºå·²å®Œæˆï¼›æ›´æ–°è·¯å¾„å®‰å…¨ä¸ºå·²å®Œæˆï¼›æ›´æ–°å¹¶å‘é”ä¸ºå·²æ”¹è¿›ï¼›æ–°å¢å·²åšå¾—å¥½çš„éƒ¨åˆ† |
| 2026-01-31 | åˆå§‹ç‰ˆæœ¬ |
