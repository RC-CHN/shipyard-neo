# Bay E2E test config for Docker container-network mode
#
# This config is used when Bay runs in a Docker container and connects to
# Ship containers via a shared Docker network (container IP direct connect).
#
# Usage:
#   docker-compose -f tests/scripts/docker-network/docker-compose.yaml up

server:
  host: "0.0.0.0"
  port: 8000

database:
  # Use separate test database (inside container)
  url: "sqlite+aiosqlite:///./bay-e2e-test.db"
  echo: false

driver:
  type: docker
  docker:
    socket: "unix:///var/run/docker.sock"
    # Bay in container, Ship in container - use container network direct connect
    connect_mode: container_network
    # Shared network name
    network: "bay-e2e-test-network"
    # Disable host port mapping (not needed in container network mode)
    publish_ports: false
    host_port: null

cargo:
  root_path: "/var/lib/bay/cargos"
  default_size_limit_mb: 1024
  mount_path: "/workspace"

security:
  # E2E test mode: require API key for authentication testing
  api_key: "e2e-test-api-key"
  allow_anonymous: false

profiles:
  - id: python-default
    image: "ship:latest"
    runtime_type: ship
    runtime_port: 8123
    resources:
      cpus: 1.0
      memory: "1g"
    capabilities:
      - filesystem
      - shell
      - python
      - upload
      - download
    idle_timeout: 300  # Shorter timeout for tests
    env: {}

  # Restricted profile for capability enforcement testing
  - id: python-only-test
    image: "ship:latest"
    runtime_type: ship
    runtime_port: 8123
    resources:
      cpus: 1.0
      memory: "1g"
    capabilities:
      - python  # Only python - no shell/filesystem access
    idle_timeout: 300
    env: {}

  # Profile with very short idle_timeout for GC testing
  # Used by test_idle_session_gc_reclaims_compute_and_allows_recreate
  - id: short-idle-test
    image: "ship:latest"
    runtime_type: ship
    runtime_port: 8123
    resources:
      cpus: 1.0
      memory: "1g"
    capabilities:
      - filesystem
      - shell
      - python
    idle_timeout: 2  # Very short - 2 seconds for quick GC testing
    env: {}

  # Profile with strict memory limit for OOM testing (Phase 1.5)
  # Used by test_oom_killed.py to verify container OOM behavior
  - id: oom-test
    image: "ship:latest"
    runtime_type: ship
    runtime_port: 8123
    resources:
      cpus: 1.0
      memory: "128m"  # Strict 128MB limit to trigger OOM quickly
    capabilities:
      - filesystem
      - shell
      - python
    idle_timeout: 300
    env: {}

gc:
  # Disable automatic GC during E2E tests.
  # Tests use POST /v1/admin/gc/run to trigger GC manually when needed.
  # This provides deterministic test behavior without time-based dependencies.
  # See: plans/phase-1.5/admin-gc-api-design.md
  enabled: false
  run_on_startup: false
  interval_seconds: 300  # Not used when enabled=false

  # Make instance_id deterministic for strict orphan container cleanup
  instance_id: "bay-e2e"

  idle_session:
    enabled: true
  expired_sandbox:
    enabled: true
  orphan_cargo:
    enabled: true
  orphan_container:
    enabled: true
