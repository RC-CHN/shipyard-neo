# Bay Configuration
# This file can be placed at:
# - ./config.yaml (development)
# - /etc/bay/config.yaml (production)
# - Or set BAY_CONFIG_FILE environment variable

server:
  host: "0.0.0.0"
  port: 8000

database:
  # Phase 1: SQLite (single instance)
  # For production: postgresql+asyncpg://user:pass@host/dbname
  url: "sqlite+aiosqlite:///./bay.db"
  echo: false

driver:
  type: docker  # docker | k8s

  docker:
    socket: "unix:///var/run/docker.sock"

    # Bay ↔ Runtime 连通模式：
    # - host_port: Bay 跑在宿主机上（最常见）。通过 publish 端口映射访问 runtime。
    # - container_network: Bay 跑在容器内且与 runtime 同网络，通过容器 IP 直连。
    # - auto: 优先 container_network，失败回退 host_port。
    connect_mode: host_port

    # host_port 模式下 Bay 访问 runtime 的 host 地址
    host_address: "127.0.0.1"

    # 是否发布端口（host_port/auto 必须为 true 才能动态获取 HostPort）
    publish_ports: true

    # 固定宿主机端口（null/0 表示随机端口）
    host_port: null

    # container_network/auto 时可指定网络名；host_port 模式可不填
    network: null

cargo:
  root_path: "/var/lib/bay/cargos"
  default_size_limit_mb: 1024
  mount_path: "/workspace"  # Fixed, do not change

security:
  # API Key authentication
  # Set to enable API key validation, requests must include:
  #   Authorization: Bearer <api_key>
  # Leave null/empty to disable API key validation
  api_key: null  # Production: "your-secret-api-key"
  
  # Allow anonymous access (no authentication required)
  # Development: true (default) - allows unauthenticated requests
  # Production: false - requires valid API key
  allow_anonymous: true
  
  # Network blocklist (Phase 2)
  blocked_hosts:
    - "169.254.0.0/16"  # Cloud metadata
    - "10.0.0.0/8"
    - "172.16.0.0/12"
    - "192.168.0.0/16"

# Garbage Collection configuration
# GC automatically cleans up idle sessions, expired sandboxes, and orphan resources.
gc:
  # Master switch for GC
  enabled: true

  # Run GC once immediately on startup (before entering background loop)
  run_on_startup: true

  # Interval between GC cycles (seconds)
  interval_seconds: 300  # 5 minutes

  # Instance identifier for OrphanContainerGC Strict mode.
  # Containers with bay.instance_id != this value will NOT be touched.
  # IMPORTANT: In multi-instance deployments, each instance MUST have a unique instance_id!
  # Default derivation: BAY_GC__INSTANCE_ID env var → HOSTNAME → "bay"
  instance_id: null  # Production: "bay-instance-1"

  # Per-task configuration
  # IdleSessionGC: Reclaims compute for sandboxes that have been idle beyond idle_timeout
  idle_session:
    enabled: true

  # ExpiredSandboxGC: Deletes sandboxes that have exceeded their TTL (expires_at)
  expired_sandbox:
    enabled: true

  # OrphanCargoGC: Cleans up managed cargos whose sandbox is deleted or missing
  orphan_cargo:
    enabled: true

  # OrphanContainerGC: Cleans up orphan containers (DB record missing)
  # DISABLED BY DEFAULT due to strict safety requirements.
  # Only enable this if you understand the risks and have verified instance_id is unique.
  orphan_container:
    enabled: false

# Runtime profiles
# These define the available sandbox configurations
profiles:
  - id: python-default
    image: "ship:latest"

    # 运行时类型，决定使用哪个 Adapter（默认 ship）
    # 支持的类型：ship、browser（未来）、gpu（未来）
    runtime_type: ship

    # runtime 容器内 HTTP 端口（Ship 当前默认是 8123，见 ship 镜像启动日志）
    runtime_port: 8123

    resources:
      cpus: 1.0
      memory: "1g"
    capabilities:
      - filesystem  # includes upload/download
      - shell
      - python
    idle_timeout: 1800  # 30 minutes
    env: {}

  - id: python-data
    image: "ship:data"
    runtime_type: ship
    runtime_port: 8123
    resources:
      cpus: 2.0
      memory: "4g"
    capabilities:
      - filesystem  # includes upload/download
      - shell
      - python
    idle_timeout: 1800
    env: {}

  # Example: GPU profile (Phase 2+)
  # - id: python-gpu
  #   image: "ship:gpu"
  #   runtime_type: ship
  #   runtime_port: 8123
  #   resources:
  #     cpus: 4.0
  #     memory: "16g"
  #   capabilities:
  #     - filesystem
  #     - shell
  #     - ipython
  #   idle_timeout: 3600
  #   env:
  #     CUDA_VISIBLE_DEVICES: "0"

  # Example: Browser runtime (future)
  # - id: browser-default
  #   image: "bay-browser:latest"
  #   runtime_type: browser
  #   runtime_port: 9222
  #   resources:
  #     cpus: 2.0
  #     memory: "2g"
  #   capabilities:
  #     - browser
  #   idle_timeout: 1800
  #   env: {}
